import 'package:flutter/material.dart';
import 'package:test7/services/agora_voice_service.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:permission_handler/permission_handler.dart';
import '../theme/app_theme.dart';
import 'dart:async';

class VoiceRoomActiveScreen extends StatefulWidget {
  final Map<String, dynamic> room;
  final Map<String, dynamic> user;
  const VoiceRoomActiveScreen({
    super.key,
    required this.room,
    required this.user,
  });

  @override
  State<VoiceRoomActiveScreen> createState() => _VoiceRoomActiveScreenState();
}

class _VoiceRoomActiveScreenState extends State<VoiceRoomActiveScreen>
    with
        SingleTickerProviderStateMixin,
        WidgetsBindingObserver,
        AutomaticKeepAliveClientMixin {
  @override
  bool get wantKeepAlive => true; // Ø­ÙØ¸ state Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† Jitsi

  final _client = Supabase.instance.client;
  RealtimeChannel? _participantsSubscription;
  RealtimeChannel? _roomDeletionSubscription;
  bool _isLeaving = false;
  bool _isJoining = false;
  Timer? _heartbeatTimer;
  String? _validationError;
  List<Map<String, dynamic>> _participants = [];
  bool _isDisposed = false;
  int _heartbeatFailureCount = 0;

  late AnimationController _pulseController;
  late Animation<double> _pulseAnimation;

  Color get _roomColor {
    final colorName = widget.room['room_color'];
    if (colorName == null) return AppTheme.accentPurple;
    switch (colorName.toString()) {
      case 'purple':
        return AppTheme.accentPurple;
      case 'pink':
        return AppTheme.accentPink;
      case 'cyan':
        return AppTheme.accentCyan;
      case 'green':
        return AppTheme.accentGreen;
      case 'gold':
        return AppTheme.accentGold;
      default:
        return AppTheme.accentPurple;
    }
  }

  IconData get _roomIcon {
    final iconName = widget.room['room_icon'];
    if (iconName == null) return Icons.headset_mic_rounded;
    switch (iconName.toString()) {
      case 'music':
        return Icons.music_note_rounded;
      case 'game':
        return Icons.sports_esports_rounded;
      case 'chat':
        return Icons.chat_rounded;
      case 'study':
        return Icons.school_rounded;
      case 'podcast':
        return Icons.podcasts_rounded;
      default:
        return Icons.headset_mic_rounded;
    }
  }

  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addObserver(this);
    _initAnimation();
    if (_validateRoomData()) {
      // Ù„Ø§ Ù†ØªØµÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ - Ù†Ù†ØªØ¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¶ØºØ· Ø²Ø± "Ø§Ù†Ø¶Ù…"
      // _checkStatusAndJoin(); â† ØªÙ… ØªØ¹Ø·ÙŠÙ„Ù‡
      _subscribeToParticipants();
      _subscribeToRoomDeletion();
      // heartbeat Ø³ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„ÙØ¹Ù„ÙŠ
      _loadParticipants();
    }
  }

  void _initAnimation() {
    _pulseController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 1500),
    )..repeat(reverse: true);

    _pulseAnimation = Tween<double>(begin: 1.0, end: 1.2).animate(
      CurvedAnimation(parent: _pulseController, curve: Curves.easeInOut),
    );
  }

  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    super.didChangeAppLifecycleState(state);

    if (state == AppLifecycleState.detached ||
        (state == AppLifecycleState.paused && !GroupCallService.isInCall)) {
      // App ÙŠØºÙ„Ù‚ Ø£Ùˆ ÙŠØ°Ù‡Ø¨ Ù„Ù„Ø®Ù„ÙÙŠØ© ÙˆÙ‡Ùˆ Ù„ÙŠØ³ ÙÙŠ Ù…ÙƒØ§Ù„Ù…Ø© - ØªÙ†Ø¸ÙŠÙ Ø³Ø±ÙŠØ¹
      debugPrint(
        'ğŸ”„ App lifecycle: $state (InCall: ${GroupCallService.isInCall}) - cleaning up',
      );
      _removeParticipantFromDB().catchError((e) {
        debugPrint('âš ï¸ Lifecycle cleanup error: $e');
      });
    }
  }

  @override
  void dispose() {
    WidgetsBinding.instance.removeObserver(this);
    _isDisposed = true;
    _heartbeatTimer?.cancel();
    _pulseController.dispose();
    if (_participantsSubscription != null) {
      _client.removeChannel(_participantsSubscription!);
      _participantsSubscription = null;
    }
    if (_roomDeletionSubscription != null) {
      GroupCallService.unsubscribe(_roomDeletionSubscription!);
      _roomDeletionSubscription = null;
    }
    // Ù„Ø§ Ù†Ø³ØªØ·ÙŠØ¹ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ async ÙÙŠ dispose - Ø³ÙŠØ­Ø¯Ø« ÙÙŠ _leaveRoom
    super.dispose();
  }

  bool _validateRoomData() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¹Ø±Ù Ù…Ø³ØªØ®Ø¯Ù…
    final userId = widget.user['id'];
    if (userId == null || userId.toString().isEmpty) {
      setState(() {
        _validationError = 'Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
        _isJoining = false;
      });
      debugPrint('âŒ Invalid user ID: $userId');
      return false;
    }

    // Ø§Ù„Ø¶ÙŠÙˆÙ Ø§Ù„Ø³Ø±ÙŠØ¹ÙˆÙ† Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… (ÙŠØ­ØªØ§Ø¬ÙˆÙ† UUID Ø­Ù‚ÙŠÙ‚ÙŠ)
    if (userId.toString() == 'guest') {
      setState(() {
        _validationError = 'ÙŠØ¬Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ÙƒØ§Ù…Ù„ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±Ù Ø§Ù„ØµÙˆØªÙŠØ©';
        _isJoining = false;
      });
      debugPrint('âŒ Guest user cannot join: $userId');
      return false;
    }

    debugPrint('âœ… User ID: $userId');

    if (widget.room['room_name'] == null ||
        widget.room['room_name'].toString().isEmpty) {
      setState(() {
        _validationError = 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
        _isJoining = false;
      });
      return false;
    }

    return true;
  }

  void _startHeartbeat() {
    _heartbeatTimer = Timer.periodic(const Duration(seconds: 30), (
      timer,
    ) async {
      // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¹Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù…ÙƒØ§Ù„Ù…Ø© JitsiØŒ Ù†ØªÙˆÙ‚Ù Ø¹Ù† Ø¥Ø±Ø³Ø§Ù„ Heartbeat
      if (!GroupCallService.isInCall) {
        debugPrint('â¹ï¸ Stopping heartbeat because call ended');
        timer.cancel();
        return;
      }

      if (!_isLeaving && mounted) {
        try {
          await _client.from('voice_room_participants').upsert({
            'room_name': widget.room['room_name'],
            'user_id': widget.user['id'],
            'last_seen': DateTime.now().toIso8601String(),
          }, onConflict: 'room_name,user_id');

          // Ù†Ø¬Ø­ - reset counter
          _heartbeatFailureCount = 0;
        } catch (e) {
          _heartbeatFailureCount++;
          debugPrint('âŒ Heartbeat error ($_heartbeatFailureCount/3): $e');

          // Ø¥Ø°Ø§ ÙØ´Ù„ 3 Ù…Ø±Ø§Øª Ù…ØªØªØ§Ù„ÙŠØ© (90 Ø«Ø§Ù†ÙŠØ©)
          if (_heartbeatFailureCount >= 3) {
            debugPrint('âš ï¸ Heartbeat failed 3 times - leaving room');
            timer.cancel();
            await _leaveRoom();
          }
        }
      }
    });
  }

  Future<void> _loadParticipants() async {
    try {
      final response = await _client
          .from('voice_room_participants')
          .select('*, users:user_id(id, name, username, profile_image)')
          .eq('room_name', widget.room['room_name'])
          .timeout(const Duration(seconds: 10));

      if (mounted) {
        setState(() {
          _participants = List<Map<String, dynamic>>.from(response);
        });
      }
    } catch (e) {
      debugPrint('âŒ Error loading participants: $e');
    }
  }

  void _subscribeToParticipants() {
    try {
      _participantsSubscription = _client
          .channel('room_${widget.room['room_name']}_participants')
          .onPostgresChanges(
            event: PostgresChangeEvent.all,
            schema: 'public',
            table: 'voice_room_participants',
            filter: PostgresChangeFilter(
              type: PostgresChangeFilterType.eq,
              column: 'room_name',
              value: widget.room['room_name'],
            ),
            callback: (payload) {
              _loadParticipants();
            },
          )
          .subscribe();
    } catch (e) {
      debugPrint('âŒ Error subscribing to participants: $e');
    }
  }

  Future<void> _removeParticipantFromDB() async {
    try {
      await _client
          .from('voice_room_participants')
          .delete()
          .eq('room_name', widget.room['room_name'])
          .eq('user_id', widget.user['id'])
          .timeout(const Duration(seconds: 10)); // Ø­Ø¯ Ø²Ù…Ù†ÙŠ Ù„Ù„Ø­Ø°Ù
    } catch (e) {
      debugPrint('âŒ Error removing participant from DB: $e');
    }
  }

  Future<void> _checkStatusAndJoin() async {
    debugPrint('ğŸ”µ START _checkStatusAndJoin');
    if (_isDisposed) {
      debugPrint('âŒ Disposed - aborting');
      return;
    }

    try {
      debugPrint('ğŸ”µ Requesting mic permission...');
      final micStatus = await Permission.microphone.request().timeout(
        const Duration(seconds: 10),
        onTimeout: () {
          debugPrint('â±ï¸ Mic permission timeout');
          return PermissionStatus.denied;
        },
      );
      debugPrint('ğŸ”µ Mic status: $micStatus');
      if (!_isJoining || _isDisposed) {
        return; // ÙØ­Øµ Ø§Ù„Ø¥Ù„ØºØ§Ø¡
      }

      debugPrint('ğŸ”µ Requesting camera permission...');
      final cameraStatus = await Permission.camera.request().timeout(
        const Duration(seconds: 10),
        onTimeout: () {
          debugPrint('â±ï¸ Camera permission timeout');
          return PermissionStatus.denied;
        },
      );
      debugPrint('ğŸ”µ Camera status: $cameraStatus');
      if (!_isJoining || _isDisposed) {
        return; // ÙØ­Øµ Ø§Ù„Ø¥Ù„ØºØ§Ø¡
      }

      if (micStatus != PermissionStatus.granted) {
        debugPrint('âŒ Mic not granted');
        if (mounted) {
          _showPermissionError('Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†', micStatus);
          Navigator.pop(context);
        }
        return;
      }

      if (cameraStatus != PermissionStatus.granted) {
        debugPrint('âŒ Camera not granted');
        if (mounted) {
          _showPermissionError('Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§', cameraStatus);
          Navigator.pop(context);
        }
        return;
      }

      debugPrint('âœ… Permissions granted - calling joinCall...');

      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù…Ø¹ timeout
      debugPrint('ğŸš€ Calling GroupCallService.joinCall...');
      if (!_isJoining || _isDisposed) {
        return; // ÙØ­Øµ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ù‚Ø¨Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Jitsi
      }

      await GroupCallService.joinCall(
        userName: widget.user['name'] ?? 'Ù…Ø³ØªØ®Ø¯Ù…',
        roomName: widget.room['room_name'],
        userId: widget.user['id'],
      ).timeout(
        const Duration(seconds: 20),
        onTimeout: () async {
          debugPrint('â±ï¸ Join overall timeout - cleaning up...');
          await _removeParticipantFromDB().catchError((_) {});
          throw TimeoutException('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø¯Ù…Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹');
        },
      );

      debugPrint('âœ… joinCall completed successfully!');
      if (!_isJoining || _isDisposed) {
        // Ø¥Ø°Ø§ Ø£Ù„ØºÙ‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ù†ØºÙ„Ù‚ Jitsi ÙÙˆØ±Ø§Ù‹
        debugPrint('ğŸš« User cancelled during joinCall - hanging up');
        await GroupCallService.hangUp().catchError(
          (e) => debugPrint('Error after cancel: $e'),
        );
        return;
      }

      // Ø¨Ø¯Ø¡ heartbeat Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ù†Ø§Ø¬Ø­
      if (!_isDisposed) {
        debugPrint('ğŸ”µ Starting heartbeat...');
        _startHeartbeat();
      }

      if (mounted && !_isDisposed) {
        debugPrint('ğŸ”µ Setting _isJoining = false');
        setState(() => _isJoining = false);
      }
      debugPrint('âœ… END _checkStatusAndJoin - SUCCESS');
    } on TimeoutException catch (e) {
      debugPrint('âŒ TimeoutException: $e');
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: const Text('Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª'),
            backgroundColor: Colors.orange.shade700,
          ),
        );
        Navigator.pop(context);
      }
    } catch (e, stackTrace) {
      debugPrint('âŒ Error joining call: $e');
      debugPrint('Stack trace: $stackTrace');
      if (mounted) {
        String errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£: ${e.toString()}';

        // Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ© Ù„Ù„ÙˆÙŠØ¨
        if (e.toString().contains('ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙŠØ¨')) {
          errorMessage =
              'âš ï¸ Ø§Ù„ØºØ±Ù Ø§Ù„ØµÙˆØªÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙŠØ¨\nÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ·Ø¨ÙŠÙ‚ Android';
        }

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(errorMessage),
            backgroundColor: Colors.red.shade700,
            duration: const Duration(seconds: 5),
          ),
        );
        Navigator.pop(context);
      }
    }
  }

  void _showPermissionError(String permission, PermissionStatus status) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(
          status == PermissionStatus.permanentlyDenied
              ? 'ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø¥Ø°Ù† $permission Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'
              : 'ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù€$permission',
        ),
        backgroundColor: Colors.orange.shade700,
        action: status == PermissionStatus.permanentlyDenied
            ? SnackBarAction(
                label: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
                textColor: Colors.white,
                onPressed: () => openAppSettings(),
              )
            : null,
      ),
    );
  }

  void _subscribeToRoomDeletion() {
    try {
      _roomDeletionSubscription = _client
          .channel('room_${widget.room['room_name']}_deletion')
          .onPostgresChanges(
            event: PostgresChangeEvent.delete,
            schema: 'public',
            table: 'voice_rooms',
            filter: PostgresChangeFilter(
              type: PostgresChangeFilterType.eq,
              column: 'room_name',
              value: widget.room['room_name'],
            ),
            callback: (payload) => _handleRoomDeleted(),
          )
          .subscribe();
    } catch (e) {
      debugPrint('âŒ Error subscribing to deletion: $e');
    }
  }

  void _handleRoomDeleted() {
    if (!mounted || _isLeaving) return;

    // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© ÙÙˆØ±Ø§Ù‹ ÙÙŠ Jitsi
    GroupCallService.hangUp().catchError(
      (e) => debugPrint('Error hanging up: $e'),
    );

    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => AlertDialog(
        backgroundColor: const Color(0xFF1A1A2E),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        title: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(8),
              decoration: BoxDecoration(
                color: Colors.orange.withAlpha(40),
                borderRadius: BorderRadius.circular(12),
              ),
              child: const Icon(Icons.warning_rounded, color: Colors.orange),
            ),
            const SizedBox(width: 12),
            const Text('ØªÙ… Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ©', style: TextStyle(color: Colors.white)),
          ],
        ),
        content: const Text(
          'ØªÙ… Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©. Ø³ÙŠØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©.',
          style: TextStyle(color: Colors.white70),
        ),
        actions: [
          TextButton(
            onPressed: () {
              Navigator.of(context).pop();
              _leaveRoom();
            },
            child: const Text('Ø­Ø³Ù†Ø§Ù‹', style: TextStyle(color: Colors.orange)),
          ),
        ],
      ),
    );
  }

  Future<void> _leaveRoom() async {
    if (_isLeaving) return;

    // âš ï¸ CRITICAL: ØªØ¹ÙŠÙŠÙ† _isLeaving Ù‚Ø¨Ù„ cancel Ù„Ù…Ù†Ø¹ race condition
    // Ø¥Ø°Ø§ ÙƒØ§Ù† heartbeat callback ÙŠØ¹Ù…Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ø³ÙŠÙØ­Øµ _isLeaving ÙˆÙŠØªÙˆÙ‚Ù
    _isLeaving = true;

    // Ø§Ù„Ø¢Ù† Ø¢Ù…Ù† Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª
    _heartbeatTimer?.cancel();
    _heartbeatTimer = null;

    // trigger UI rebuild
    if (mounted) setState(() {});

    try {
      await GroupCallService.hangUp();

      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ù…Ù† DB Ù…Ø¹ retry
      for (int attempt = 0; attempt < 3; attempt++) {
        try {
          await _removeParticipantFromDB();
          debugPrint('âœ… Participant removed (attempt ${attempt + 1})');
          break; // Ù†Ø¬Ø­ - Ø§Ø®Ø±Ø¬
        } catch (e) {
          if (attempt == 2) {
            // Ø¢Ø®Ø± Ù…Ø­Ø§ÙˆÙ„Ø© ÙØ´Ù„Øª - cleanup service Ø³ÙŠÙ†Ø¸Ù
            debugPrint('âš ï¸ Failed to remove after 3 attempts: $e');
          } else {
            // Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
            await Future.delayed(Duration(seconds: 1));
          }
        }
      }
    } catch (e) {
      debugPrint('âŒ Error leaving: $e');
    } finally {
      if (mounted) Navigator.pop(context);
    }
  }

  @override
  Widget build(BuildContext context) {
    super.build(context); // Ù…Ø·Ù„ÙˆØ¨ Ù„Ù€ AutomaticKeepAliveClientMixin

    if (_validationError != null) {
      return _buildErrorScreen();
    }

    if (_isJoining) {
      return _buildJoiningScreen();
    }

    return PopScope(
      canPop: false,
      onPopInvokedWithResult: (didPop, result) async {
        if (didPop) return;
        await _leaveRoom();
      },
      child: Scaffold(
        backgroundColor: const Color(0xFF0A0A1A),
        body: Container(
          decoration: BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topCenter,
              end: Alignment.bottomCenter,
              colors: [
                _roomColor.withAlpha(20),
                const Color(0xFF0A0A1A),
                const Color(0xFF0A0A1A),
              ],
            ),
          ),
          child: SafeArea(
            child: Column(
              children: [
                _buildHeader(),
                Expanded(child: _buildContent()),
                _buildFooter(),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildHeader() {
    return Container(
      padding: const EdgeInsets.all(20),
      child: Row(
        children: [
          // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØºØ±ÙØ©
          Container(
            padding: const EdgeInsets.all(14),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [_roomColor.withAlpha(100), _roomColor.withAlpha(50)],
              ),
              borderRadius: BorderRadius.circular(16),
              boxShadow: [
                BoxShadow(
                  color: _roomColor.withAlpha(80),
                  blurRadius: 20,
                  spreadRadius: 2,
                ),
              ],
            ),
            child: Icon(_roomIcon, color: Colors.white, size: 28),
          ),
          const SizedBox(width: 16),
          // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØºØ±ÙØ©
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  widget.room['title'] ?? 'ØºØ±ÙØ© Ù…Ø­Ø§Ø¯Ø«Ø©',
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                  ),
                  maxLines: 1,
                  overflow: TextOverflow.ellipsis,
                ),
                const SizedBox(height: 4),
                Row(
                  children: [
                    AnimatedBuilder(
                      animation: _pulseAnimation,
                      builder: (context, child) => Container(
                        width: 8,
                        height: 8,
                        decoration: BoxDecoration(
                          color: const Color(0xFF22C55E),
                          shape: BoxShape.circle,
                          boxShadow: [
                            BoxShadow(
                              color: const Color(0xFF22C55E).withAlpha(
                                (100 * _pulseAnimation.value).toInt(),
                              ),
                              blurRadius: 8 * _pulseAnimation.value,
                            ),
                          ],
                        ),
                      ),
                    ),
                    const SizedBox(width: 8),
                    Text(
                      '${_participants.length} Ù…Ø´Ø§Ø±Ùƒ',
                      style: TextStyle(
                        color: Colors.white.withAlpha(180),
                        fontSize: 14,
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
          // Ø²Ø± Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©
          GestureDetector(
            onTap: _leaveRoom,
            child: Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Colors.red.withAlpha(40),
                borderRadius: BorderRadius.circular(14),
                border: Border.all(color: Colors.red.withAlpha(100)),
              ),
              child: const Icon(
                Icons.call_end_rounded,
                color: Colors.red,
                size: 24,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildContent() {
    return SingleChildScrollView(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      child: Column(
        children: [
          const SizedBox(height: 20),
          // Ø±Ø³Ø§Ù„Ø© Jitsi
          Container(
            padding: const EdgeInsets.all(24),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [Colors.white.withAlpha(10), Colors.white.withAlpha(5)],
              ),
              borderRadius: BorderRadius.circular(20),
              border: Border.all(color: _roomColor.withAlpha(60)),
            ),
            child: Column(
              children: [
                Icon(Icons.video_call_rounded, size: 80, color: _roomColor),
                const SizedBox(height: 20),
                const Text(
                  'Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 22,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 12),
                Text(
                  'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø§Ù†Ø¶Ù… Ø§Ù„Ø¢Ù†" Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©',
                  textAlign: TextAlign.center,
                  style: TextStyle(
                    color: Colors.white.withAlpha(150),
                    fontSize: 15,
                  ),
                ),
                const SizedBox(height: 24),
                // Ø²Ø± Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
                ElevatedButton.icon(
                  onPressed: () async {
                    if (_isJoining) return;
                    if (!mounted) return;
                    setState(() => _isJoining = true);
                    try {
                      await _checkStatusAndJoin();
                    } finally {
                      if (mounted) setState(() => _isJoining = false);
                    }
                  },
                  icon: const Icon(Icons.call, color: Colors.white),
                  label: const Text(
                    'Ø§Ù†Ø¶Ù… Ø§Ù„Ø¢Ù†',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: _roomColor,
                    padding: const EdgeInsets.symmetric(
                      horizontal: 40,
                      vertical: 16,
                    ),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(16),
                    ),
                    elevation: 8,
                    shadowColor: _roomColor.withAlpha(100),
                  ),
                ),
              ],
            ),
          ),
          const SizedBox(height: 30),
          // Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ†
          if (_participants.isNotEmpty) ...[
            Row(
              children: [
                Icon(Icons.people_rounded, color: _roomColor, size: 20),
                const SizedBox(width: 8),
                Text(
                  'Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ† (${_participants.length})',
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ],
            ),
            const SizedBox(height: 16),
            ..._participants.map((participant) {
              final user = participant['users'] as Map<String, dynamic>?;
              final name = user?['name'] ?? 'Ù…Ø³ØªØ®Ø¯Ù…';
              final profileImage = user?['profile_image'];

              return Container(
                margin: const EdgeInsets.only(bottom: 12),
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.white.withAlpha(8),
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(color: Colors.white.withAlpha(20)),
                ),
                child: Row(
                  children: [
                    CircleAvatar(
                      radius: 24,
                      backgroundColor: _roomColor.withAlpha(60),
                      backgroundImage: profileImage != null
                          ? NetworkImage(profileImage)
                          : null,
                      child: profileImage == null
                          ? Text(
                              name.isNotEmpty ? name[0].toUpperCase() : '?',
                              style: const TextStyle(
                                color: Colors.white,
                                fontWeight: FontWeight.bold,
                              ),
                            )
                          : null,
                    ),
                    const SizedBox(width: 14),
                    Expanded(
                      child: Text(
                        name,
                        style: const TextStyle(
                          color: Colors.white,
                          fontSize: 16,
                          fontWeight: FontWeight.w500,
                        ),
                      ),
                    ),
                    Icon(
                      Icons.check_circle_rounded,
                      color: _roomColor,
                      size: 20,
                    ),
                  ],
                ),
              );
            }),
          ],
        ],
      ),
    );
  }

  Widget _buildFooter() {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topCenter,
          end: Alignment.bottomCenter,
          colors: [Colors.transparent, Colors.black.withAlpha(150)],
        ),
      ),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(Icons.info_outline_rounded, color: _roomColor, size: 20),
          const SizedBox(width: 8),
          Expanded(
            child: Text(
              'Ø§Ø³ØªØ®Ø¯Ù… Ø£Ø¯ÙˆØ§Øª Jitsi Ù„Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„',
              style: TextStyle(
                color: Colors.white.withAlpha(180),
                fontSize: 13,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildJoiningScreen() {
    return Scaffold(
      backgroundColor: const Color(0xFF0A0A1A),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            AnimatedBuilder(
              animation: _pulseAnimation,
              builder: (context, child) => Transform.scale(
                scale: _pulseAnimation.value * 0.9 + 0.1,
                child: Container(
                  padding: const EdgeInsets.all(40),
                  decoration: BoxDecoration(
                    gradient: RadialGradient(
                      colors: [
                        _roomColor.withAlpha(60),
                        _roomColor.withAlpha(20),
                        Colors.transparent,
                      ],
                    ),
                    shape: BoxShape.circle,
                  ),
                  child: Icon(_roomIcon, size: 60, color: _roomColor),
                ),
              ),
            ),
            const SizedBox(height: 40),
            const Text(
              'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…...',
              style: TextStyle(
                color: Colors.white,
                fontSize: 22,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 12),
            Text(
              widget.room['title'] ?? 'ØºØ±ÙØ© Ù…Ø­Ø§Ø¯Ø«Ø©',
              style: TextStyle(
                color: Colors.white.withAlpha(150),
                fontSize: 16,
              ),
            ),
            const SizedBox(height: 40),
            SizedBox(
              width: 40,
              height: 40,
              child: CircularProgressIndicator(
                color: _roomColor,
                strokeWidth: 3,
              ),
            ),
            const SizedBox(height: 60),
            // Ø²Ø± Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
            TextButton.icon(
              onPressed: () {
                if (!mounted) return;
                setState(() => _isJoining = false);
                debugPrint('ğŸš« Joining cancelled by user');
              },
              icon: const Icon(Icons.close_rounded, color: Colors.white70),
              label: const Text(
                'Ø¥Ù„ØºØ§Ø¡',
                style: TextStyle(color: Colors.white70, fontSize: 16),
              ),
              style: TextButton.styleFrom(
                padding: const EdgeInsets.symmetric(
                  horizontal: 24,
                  vertical: 12,
                ),
                backgroundColor: Colors.white.withAlpha(20),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildErrorScreen() {
    return Scaffold(
      backgroundColor: const Color(0xFF0A0A1A),
      body: Center(
        child: Padding(
          padding: const EdgeInsets.all(40),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Container(
                padding: const EdgeInsets.all(24),
                decoration: BoxDecoration(
                  color: Colors.red.withAlpha(30),
                  shape: BoxShape.circle,
                ),
                child: const Icon(
                  Icons.error_outline_rounded,
                  color: Colors.red,
                  size: 60,
                ),
              ),
              const SizedBox(height: 32),
              const Text(
                'Ø­Ø¯Ø« Ø®Ø·Ø£',
                style: TextStyle(
                  color: Colors.white,
                  fontSize: 22,
                  fontWeight: FontWeight.bold,
                ),
              ),
              const SizedBox(height: 12),
              Text(
                _validationError!,
                style: TextStyle(
                  color: Colors.white.withAlpha(150),
                  fontSize: 16,
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 40),
              ElevatedButton(
                onPressed: () => Navigator.pop(context),
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.white.withAlpha(20),
                  padding: const EdgeInsets.symmetric(
                    horizontal: 32,
                    vertical: 14,
                  ),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(20),
                  ),
                ),
                child: const Text(
                  'Ø±Ø¬ÙˆØ¹',
                  style: TextStyle(color: Colors.white, fontSize: 16),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
